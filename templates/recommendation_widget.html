<!-- Recommendation Widget - Can be refreshed via HTMX -->

<div class="recommendation-hero">
    <div class="recommendation-question">
        {% if recommendation.ticker == 'MARKET' %}
        Is now a good time to buy stocks?
        {% else %}
        Is now a good time to buy <strong style="font-family: 'JetBrains Mono', monospace;">{{ recommendation.ticker }}</strong>?
        {% endif %}
    </div>

    <div class="recommendation-badge"
         style="background: {{ recommendation.recommendation.bg_color }}; color: {{ recommendation.recommendation.color }};">
        {{ recommendation.recommendation.action }}
    </div>

    <div class="recommendation-score {% if recommendation.composite_score > 20 %}positive{% elif recommendation.composite_score < -20 %}negative{% else %}neutral{% endif %}">
        {% if recommendation.composite_score > 0 %}+{% endif %}{{ recommendation.composite_score }}
    </div>

    <div class="recommendation-description">
        {{ recommendation.recommendation.description }}
    </div>

    <!-- Confidence Section -->
    {% if recommendation.confidence %}
    <div class="confidence-section" style="justify-content: center;">
        <span class="confidence-label">Confidence:</span>
        <span class="confidence-badge {{ recommendation.confidence.level }}">
            {{ recommendation.confidence.level }}
        </span>
        <span class="confidence-label" style="margin-left: 1rem;">
            Data Quality: {{ (recommendation.confidence.data_quality * 100)|round|int }}% |
            Signal Agreement: {{ (recommendation.confidence.signal_agreement * 100)|round|int }}%
        </span>
    </div>
    {% endif %}

    {% if recommendation.timestamp %}
    <div class="timestamp">
        Updated: {{ recommendation.timestamp[:19].replace('T', ' ') }}
    </div>
    {% endif %}
</div>

<!-- Score Breakdown -->
{% if recommendation.breakdown %}
<div class="score-breakdown">
    <!-- Technical Score -->
    {% if recommendation.breakdown.technical %}
    <div class="breakdown-card">
        <div class="breakdown-header">
            <span class="breakdown-title">Price/Technical</span>
            <span class="breakdown-weight">{{ recommendation.breakdown.technical.weight }}</span>
        </div>
        <div class="breakdown-score {% if recommendation.breakdown.technical.score > 10 %}positive{% elif recommendation.breakdown.technical.score < -10 %}negative{% else %}neutral{% endif %}"
             style="color: {% if recommendation.breakdown.technical.score > 10 %}#22c55e{% elif recommendation.breakdown.technical.score < -10 %}#ef4444{% else %}#6b7280{% endif %}">
            {% if recommendation.breakdown.technical.score > 0 %}+{% endif %}{{ recommendation.breakdown.technical.score }}
        </div>
        <div class="breakdown-bar">
            <div class="breakdown-bar-fill {% if recommendation.breakdown.technical.score > 10 %}positive{% elif recommendation.breakdown.technical.score < -10 %}negative{% else %}neutral{% endif %}"
                 style="width: {{ ((recommendation.breakdown.technical.score + 100) / 2)|round }}%;">
            </div>
        </div>
        <div class="breakdown-quality">
            Data quality: {{ recommendation.breakdown.technical.data_quality }}
        </div>
    </div>
    {% endif %}

    <!-- Sentiment Score -->
    {% if recommendation.breakdown.sentiment %}
    <div class="breakdown-card">
        <div class="breakdown-header">
            <span class="breakdown-title">News Sentiment</span>
            <span class="breakdown-weight">{{ recommendation.breakdown.sentiment.weight }}</span>
        </div>
        <div class="breakdown-score"
             style="color: {% if recommendation.breakdown.sentiment.score > 10 %}#22c55e{% elif recommendation.breakdown.sentiment.score < -10 %}#ef4444{% else %}#6b7280{% endif %}">
            {% if recommendation.breakdown.sentiment.score > 0 %}+{% endif %}{{ recommendation.breakdown.sentiment.score }}
        </div>
        <div class="breakdown-bar">
            <div class="breakdown-bar-fill {% if recommendation.breakdown.sentiment.score > 10 %}positive{% elif recommendation.breakdown.sentiment.score < -10 %}negative{% else %}neutral{% endif %}"
                 style="width: {{ ((recommendation.breakdown.sentiment.score + 100) / 2)|round }}%;">
            </div>
        </div>
        <div class="breakdown-quality">
            Data quality: {{ recommendation.breakdown.sentiment.data_quality }}
        </div>
    </div>
    {% endif %}

    <!-- Macro Score -->
    {% if recommendation.breakdown.macro %}
    <div class="breakdown-card">
        <div class="breakdown-header">
            <span class="breakdown-title">Economic/Macro</span>
            <span class="breakdown-weight">{{ recommendation.breakdown.macro.weight }}</span>
        </div>
        <div class="breakdown-score"
             style="color: {% if recommendation.breakdown.macro.score > 10 %}#22c55e{% elif recommendation.breakdown.macro.score < -10 %}#ef4444{% else %}#6b7280{% endif %}">
            {% if recommendation.breakdown.macro.score > 0 %}+{% endif %}{{ recommendation.breakdown.macro.score }}
        </div>
        <div class="breakdown-bar">
            <div class="breakdown-bar-fill {% if recommendation.breakdown.macro.score > 10 %}positive{% elif recommendation.breakdown.macro.score < -10 %}negative{% else %}neutral{% endif %}"
                 style="width: {{ ((recommendation.breakdown.macro.score + 100) / 2)|round }}%;">
            </div>
        </div>
        <div class="breakdown-quality">
            Data quality: {{ recommendation.breakdown.macro.data_quality }}
        </div>
    </div>
    {% endif %}
</div>
{% endif %}

<!-- Reasons Section -->
{% if recommendation.reasons %}
<div class="reasons-section">
    <div class="reasons-title">Key Factors</div>
    <div class="reason-list">
        {% for reason in recommendation.reasons %}
        <div class="reason-item">
            {% if '[Technical]' in reason %}
            <svg class="reason-icon technical" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 3v18h18M7 16l4-4 4 4 5-5"/>
            </svg>
            {% elif '[Sentiment]' in reason %}
            <svg class="reason-icon sentiment" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
            </svg>
            {% elif '[Economic]' in reason %}
            <svg class="reason-icon economic" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                <line x1="3" y1="9" x2="21" y2="9"/>
                <line x1="9" y1="21" x2="9" y2="9"/>
            </svg>
            {% else %}
            <svg class="reason-icon" style="color: #6b7280;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <line x1="12" y1="16" x2="12" y2="12"/>
                <line x1="12" y1="8" x2="12" y2="8"/>
            </svg>
            {% endif %}
            <span>{{ reason }}</span>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Refresh Button -->
<div style="text-align: center; margin-top: 2rem;">
    <button class="analyze-btn"
            hx-post="/refresh-recommendation{% if recommendation.ticker != 'MARKET' %}?ticker={{ recommendation.ticker }}{% endif %}"
            hx-target="#recommendation-widget"
            hx-swap="innerHTML">
        Refresh Analysis
    </button>
</div>
