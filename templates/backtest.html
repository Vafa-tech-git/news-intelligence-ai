<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Backtest Dashboard - News Intelligence AI</title>

    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="{{ url_for('static', filename='js/htmx.min.js') }}"></script>
    <style>
        .backtest-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 1.5rem; }
        .backtest-panel { background: var(--card-bg); border-radius: 12px; padding: 1.5rem; border: 1px solid var(--border-color); }
        .backtest-panel h3 { font-size: 1rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 1rem; }

        .accuracy-gauge { text-align: center; padding: 1.5rem 0; }
        .accuracy-number { font-size: 4rem; font-weight: 700; font-family: 'JetBrains Mono', monospace; line-height: 1; }
        .accuracy-number.good { color: #10b981; }
        .accuracy-number.moderate { color: #f59e0b; }
        .accuracy-number.poor { color: #ef4444; }
        .accuracy-label { font-size: 1rem; color: var(--text-secondary); margin-top: 0.5rem; }

        .signal-accuracy-table { width: 100%; border-collapse: collapse; }
        .signal-accuracy-table th, .signal-accuracy-table td { padding: 0.75rem; text-align: left; border-bottom: 1px solid var(--border-color); }
        .signal-accuracy-table th { color: var(--text-secondary); font-weight: 500; font-size: 0.875rem; }
        .signal-accuracy-table td { font-family: 'JetBrains Mono', monospace; }
        .signal-accuracy-table tr:last-child td { border-bottom: none; }

        .accuracy-bar { height: 8px; background: var(--border-color); border-radius: 4px; overflow: hidden; }
        .accuracy-fill { height: 100%; border-radius: 4px; }
        .accuracy-fill.good { background: #10b981; }
        .accuracy-fill.moderate { background: #f59e0b; }
        .accuracy-fill.poor { background: #ef4444; }

        .source-rank { display: flex; align-items: center; gap: 1rem; padding: 0.75rem 0; border-bottom: 1px solid var(--border-color); }
        .source-rank:last-child { border-bottom: none; }
        .source-rank-pos { width: 24px; height: 24px; border-radius: 50%; background: var(--accent); color: white; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 600; }
        .source-rank-name { flex: 1; font-weight: 500; }
        .source-rank-acc { font-family: 'JetBrains Mono', monospace; font-weight: 600; }

        .metric-card { background: rgba(59, 130, 246, 0.1); border-radius: 8px; padding: 1rem; text-align: center; }
        .metric-value { font-size: 2rem; font-weight: 700; font-family: 'JetBrains Mono', monospace; color: var(--accent); }
        .metric-label { font-size: 0.875rem; color: var(--text-secondary); margin-top: 0.25rem; }

        .empty-backtest { text-align: center; padding: 3rem; color: var(--text-secondary); }
        .empty-backtest svg { width: 64px; height: 64px; margin-bottom: 1rem; opacity: 0.5; }

        .info-box { background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem; }
        .info-box p { font-size: 0.875rem; color: var(--text-secondary); margin: 0; }
    </style>
</head>
<body>

    {% set active_tab = 'backtest' %}
    {% include 'components/nav.html' %}

        <div class="dashboard-header">
            <div>
                <h2 class="dashboard-title">Signal Performance</h2>
                <p class="dashboard-subtitle">Track and validate signal accuracy over time</p>
            </div>
        </div>

        <div class="info-box">
            <p>Signal performance is tracked at 1-day, 5-day, and 20-day intervals. Accuracy improves over time as more signals are generated and validated against actual market movements.</p>
        </div>

        {% if signal_stats %}
        <div class="backtest-grid">
            <!-- Overall Accuracy -->
            <div class="backtest-panel">
                <h3>Overall Accuracy</h3>
                {% set total_signals = signal_stats|sum(attribute='total') %}
                {% set profitable_signals = signal_stats|sum(attribute='profitable') %}
                {% set overall_accuracy = (profitable_signals / total_signals * 100) if total_signals > 0 else 0 %}
                <div class="accuracy-gauge">
                    <div class="accuracy-number {% if overall_accuracy >= 55 %}good{% elif overall_accuracy >= 45 %}moderate{% else %}poor{% endif %}">
                        {{ overall_accuracy|round|int }}%
                    </div>
                    <div class="accuracy-label">Win Rate</div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                    <div class="metric-card">
                        <div class="metric-value">{{ total_signals }}</div>
                        <div class="metric-label">Total Signals</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">{{ profitable_signals }}</div>
                        <div class="metric-label">Profitable</div>
                    </div>
                </div>
            </div>

            <!-- Accuracy by Signal Type -->
            <div class="backtest-panel">
                <h3>Accuracy by Signal Type</h3>
                <table class="signal-accuracy-table">
                    <thead>
                        <tr>
                            <th>Signal</th>
                            <th>Total</th>
                            <th>Win Rate</th>
                            <th>Avg Return (5d)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for stat in signal_stats %}
                        {% set accuracy = (stat.profitable / stat.total * 100) if stat.total > 0 else 0 %}
                        <tr>
                            <td style="text-transform: capitalize;">{{ stat.signal_type|replace('_', ' ') }}</td>
                            <td>{{ stat.total }}</td>
                            <td>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span>{{ accuracy|round|int }}%</span>
                                    <div class="accuracy-bar" style="width: 60px;">
                                        <div class="accuracy-fill {% if accuracy >= 55 %}good{% elif accuracy >= 45 %}moderate{% else %}poor{% endif %}" style="width: {{ accuracy }}%;"></div>
                                    </div>
                                </div>
                            </td>
                            <td style="color: {% if stat.avg_return_5d and stat.avg_return_5d > 0 %}#10b981{% elif stat.avg_return_5d and stat.avg_return_5d < 0 %}#ef4444{% else %}inherit{% endif %};">
                                {{ stat.avg_return_5d|round(2) if stat.avg_return_5d else 'N/A' }}%
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% else %}
        <div class="empty-backtest">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
            </svg>
            <h3>No performance data yet</h3>
            <p>Signal performance tracking starts automatically when signals are generated. Check back after signals have had time to be validated.</p>
        </div>
        {% endif %}

        <!-- Source Accuracy -->
        {% if source_accuracy %}
        <div class="backtest-panel" style="margin-top: 1.5rem;">
            <h3>Source Reliability Ranking</h3>
            <p style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 1rem;">
                Sources ranked by prediction accuracy. Weights are adjusted automatically based on performance.
            </p>
            {% for source in source_accuracy %}
            <div class="source-rank">
                <div class="source-rank-pos">{{ loop.index }}</div>
                <div class="source-rank-name">{{ source.source|replace('_', ' ')|title }}</div>
                <div style="flex: 1;">
                    <div class="accuracy-bar" style="max-width: 200px;">
                        <div class="accuracy-fill {% if source.accuracy_rate >= 0.55 %}good{% elif source.accuracy_rate >= 0.45 %}moderate{% else %}poor{% endif %}"
                             style="width: {{ (source.accuracy_rate * 100)|round|int }}%;"></div>
                    </div>
                </div>
                <div class="source-rank-acc" style="color: {% if source.accuracy_rate >= 0.55 %}#10b981{% elif source.accuracy_rate >= 0.45 %}#f59e0b{% else %}#ef4444{% endif %};">
                    {{ (source.accuracy_rate * 100)|round|int }}%
                </div>
                <div style="font-size: 0.875rem; color: var(--text-secondary);">
                    ({{ source.correct_predictions }}/{{ source.total_predictions }})
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}

    </main>

</body>
</html>
